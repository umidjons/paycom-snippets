# Subscribe API
## Описание
- Нужно реализовать сервер по протоколу описанной в [документации](http://paycom.uz/developers/merchant/overview).
- Нужно на фронте или приложении сделать форму для ввода карточных данных и `OTP` (`One Time Password` - `Проверочный код`). Основное требование к форме: элементы для ввода не должны иметь аттрибута `name` и тег `form` не должен иметь аттрибута `action`.
- Пользователь на фронте или приложении вводит свои карточные данные, вводит проверочный код. Вводимые пользователем данные не в коем случае не отправлять себе на сервер. Все это происходит с помощью API которые описаны ниже. В ответ на запросы от API получаете токен карты, который дальше используете в серверном API.
- Разместить логотип Payme в приложение или в форму на фронте.
- Поставить [оферту Payme](https://cdn.payme.uz/terms/main.html).
- Поставить подсказку или текст, что все данные пользователей не передаются поставщику и сохраняются на сервисе Payme.

### Пример формы
В этой форме можно увидеть логотип, подсказку и ссылку на оферту.
![Пример формы](https://cdn.paycom.uz/documentation_assets/safety_guaranteed.png)

### Логотип
| PNG | SVG |
| ------------- |:-------------:|
| ![Логотип в PNG формате](https://cdn.paycom.uz/documentation_assets/power-by-Payme.png) | ![Логотип в SVG формате](https://cdn.paycom.uz/documentation_assets/power-by-Payme.svg) |
|[Логотип в PNG формате](https://cdn.paycom.uz/documentation_assets/power-by-Payme.png) | [Логотип в SVG формате](https://cdn.paycom.uz/documentation_assets/power-by-Payme.svg) |

## Endpoints

Endpoint для серверного и фронт API один и тотже: `https://checkout.paycom.uz/api`
Для тестов `http://checkout.test.paycom.uz/api`

Для авторизации вам необходимо отправить заголовок `X-Auth`.

| Для Front-End | Для Back-End |
| ------------- |:-------------:|
| `X-Auth: {id}`| `X-Auth: {id}:{key}` |

## Методы для Front-End
API строятся на основе `json-rpc`, поэтому далее я буду описывать в этом контексте
### cards.create
Метод для создание токена карты.

Параметры:
```js
card: {
    number String,
    expire: String
},
amount: Number,
account: Object,
save: Boolean
```

| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `card`    | Object  | параметры карты |
| `number`  | String  | номер карты |
| `expire`  | String  | дата истечения карты |
| `amount`  | Number  | запрашиваемая сумма платежа |
| `account?` | Object  | объект Account, данный параметр не обязательный |
| `save?`    | Boolean | данный параметр не обязательный. Если флаг `true` токен можно будет использовать для дальнейших платежей, если флаг `false` токеном можно будет сделать только 1 оплату, после чего токен будет недоступен. Данное поле должно проставляться пользователем, (например `checkbox` `Запонить карту`, по умолчанию `checkbox` должен быть выключен).|

Результат:
```js
{
    card: {
        number: String,
        expire: String,
        token: String,
        recurrent: Boolean,
        verify: Boolean
    }
}
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `number` | String | не полный номер карты, данную строку можете сохранить у себя на сервере |
| `expire` | String | дата истечения карты |
| `token` | String | токен карты |
| `recurrent`| Boolean | флаг, доступна ли карта для последующих платежей |
| `verify` | Boolean | флаг, верифицирована ли карта |

### cards.get_verify_code
Метод запрашивает код для верификации карты.

Параметры:
```
token: String - токен карты
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `token` | String | токен карты |

Результат:
```js
{
    sent: true,
    phone: String,
    wait: Number
}
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `sent` | Boolean | флаг результата отправки |
| `phone` | String | не полный номер карты куда была отправлена смс с кодом |
| `wait` | Number | время в милиссикундах которое необходимо выждать перед повторным запросом кода |

### cards.verify
Метод верифицирует карту с помощью кода отправленного по СМС.

Параметры:
```js
{
    token: String,
    code: String
}
```

| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `token` | String | токен карты |
| `code` | String | код для верификации |

## Методы для серверной части
### cards.remove
Метод для удаления токена.
Параметры:
```js
token: String
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `token` | String | токен карты |

### cards.check
Метод для проверка токена карты.
Параметры:
```js
token: String
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `token` | String | токен карты |
Результат:
```js
{
    card: {
        number: String,
        expire: String,
        token: String,
        recurrent: Boolean,
        verify: Boolean
    }
}
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `number` | String | не полный номер карты, данную строку можете сохранить у себя на сервере |
| `expire` | String | дата истечения карты |
| `token` | String | токен карты |
| `recurrent` | Boolean | флаг, доступна ли карта для последующих платежей |
| `verify` | Boolean | флаг, верифицирована ли карта |

### receipts.create
Метод создает чек для оплаты.
Параметры:
```js
amount: Number,
account: Object,
description: String,
detail: Object
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `amount` | Number | Сумма платежа в тиинах |
| `account` | Object | Объект `Account` |
| `description?` | String | Необязательный параметр. Описание платежа. |
| `detail?` | Object | Необязательный параметр. Объект детализации платежа. |

Ответ:
```
result.receipt
```

Пример ответа:
```json
{
  "jsonrpc": "2.0",
  "id": null,
  "result": {
    "receipt": {
      "_id": "7e0b6c1f16ab68d1beae111b",
      "create_time": 1481009482171,
      "pay_time": 0,
      "cancel_time": 0,
      "state": 0,
      "type": 1,
      "external": false,
      "operation": -1,
      "category": null,
      "error": null,
      "description": "",
      "detail": null,
      "amount": 3500,
      "commission": 0,
      "account": [
        {
          "name": "order_id",
          "title": "Код заказа",
          "value": "2"
        }
      ],
      "card": null,
      "merchant": {
        "_id": "583fe486b33784292111b7dc",
        "name": "Online Shop LLC",
        "organization": "ЧП «Online Shop»",
        "address": "",
        "epos": {
          "merchantId": "106600000050000",
          "terminalId": "20660000"
        },
        "date": 1480582278779,
        "logo": null,
        "type": "Shop",
        "terms": null
      },
      "meta": null
    }
  }
}
```

### receipts.pay
Метод для оплаты чека.
Параметры:
```js
id: String,
token: String,
payer: {
    id: String,
    phone: String,
    email: String,
    name: String,
    ip: String
}
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `id` | String | ID Чека |
| `token` | String | Токен карты |
| `payer?` | Object | Дополнительная информация о плательщике, необходима для системы антифрода, все поля данного объекта не обязательны |

Пример ответа:
```json
{
  "jsonrpc": "2.0",
  "id": null,
  "result": {
    "receipt": {
      "_id": "7e0b7111ea2c87cdd22f26ae",
      "create_time": 1481113810044,
      "pay_time": 1481113810265,
      "cancel_time": 0,
      "state": 4,
      "type": 1,
      "external": false,
      "operation": -1,
      "category": null,
      "error": null,
      "description": "",
      "detail": null,
      "amount": 3500,
      "commission": 0,
      "account": [
        {
          "name": "order_id",
          "title": "Код заказа",
          "value": "5"
        }
      ],
      "card": {
        "number": "444444******4444",
        "expire": "1704"
      },
      "merchant": {
        "_id": "583fe486b33784292111b7dc",
        "name": "Online Shop LLC",
        "organization": "ЧП «Online Shop»",
        "address": "",
        "epos": {
          "merchantId": "106600000050000",
          "terminalId": "20660000"
        },
        "date": 1480582278779,
        "logo": null,
        "type": "Shop",
        "terms": null
      },
      "meta": null
    }
  }
}
```

### receipts.cancel
Метод ставит в очередь на отмену оплаченный чек.
Параметры:
```js
id: String,
partially: {
    receivers: Array<{
        id: String,
        hold: Number
    }>,
    description: String,
    detail: Object
}
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `id`       | String | ID Чека          |
| `partially?`| Object | Необязательный параметр. При указании данного параметра, чек будет отменен не полностью, а только получатели из переданного списка `receivers`. При этом текущий чек будет помечен как отмененный, и вернется новый чек с перещитанной суммой. |
| `receivers` | Array<Object> | Список получателей которых необходимо исключить из оригинального чека |
| `receivers.id` | String | `id` получателя которого необходимо исключить из чека |
| `hold?`      | Number | Необязательный параметр. Сумму которую нужно удержать на счету получателя. Данный параметр временно не работает. |
| `description?` | String | Необязательный параметр. Описание для новго чека. Если не указать данный параметр, он будет скопирован из оригинального чека. |
| `detail?` | Object | Необязательный параметр. Детализация нового чека. Если не указать данный параметр, он будет скопирован из оригинального чека. |

### receipts.check
Метод для проверки статуса чека.
Параметры:
```js
id: String
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `id` | String | ID Чека |

### receipts.get
Метод возвращает полную информацияю по чеку.

Параметры:
```js
id: String
```
| Параметр  | Тип     | Описание |
|-----------|---------|----------|
| `id` | String | ID Чека |

### Статусы чека
| Код | Описание |
|-----------|------------------|
| `0` | чек создан и ожидает подтверждение оплаты |
| `1` | запущена оплата, идет первая стадия проверок, создание транзакции в билинге поставщика |
| `2` | снятие средств с карты |
| `3` | закрытие транзакции в билинге поставщика |
| `4` | чек полностью проведен |
| `20` | чек стоит на паузе для ручного вмешательства |
| `21` | чек стоит в очереди на отмену |
| `30` | чек стоит в очереди на закрытие транзакции в билинге поставщика |
| `50` | чек отменен |
